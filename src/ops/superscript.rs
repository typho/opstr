use crate::auxiliary;
use crate::config::Configuration;
use crate::errors::LibError;
use crate::input::Args;
use crate::ops::traits;
use crate::output::Output;
use crate::range;

// TODO this map is incomplete
// c.f. https://en.wikipedia.org/wiki/Unicode_subscripts_and_superscripts
// TODO "superscript" versus "superscript small cap"

// TODO read data based on https://en.wikipedia.org/wiki/Unicode_character_property


pub struct Superscript {}

impl Superscript {
    const SUPERSCRIPT_MAP: &'static [(char, char)] = &[
        // digits and symbols
        ('+', 'âº'),
        ('-', 'â»'),
        ('=', 'â¼'),
        ('(', 'â½'),
        (')', 'â¾'),
        ('0', 'â°'),
        ('1', 'Â¹'),
        ('2', 'Â²'),
        ('3', 'Â³'),
        ('4', 'â´'),
        ('5', 'âµ'),
        ('6', 'â¶'),
        ('7', 'â·'),
        ('8', 'â¸'),
        ('9', 'â¹'),
        // latin letters
        ('A', 'á´¬'),
        ('B', 'á´®'),
        ('D', 'á´°'),
        ('E', 'á´±'),
        ('G', 'á´³'),
        ('H', 'á´´'),
        ('I', 'á´µ'),
        ('J', 'á´¶'),
        ('K', 'á´·'),
        ('L', 'á´¸'),
        ('M', 'á´¹'),
        ('N', 'á´º'),
        ('O', 'á´¼'),
        ('P', 'á´¾'),
        ('R', 'á´¿'),
        ('T', 'áµ€'),
        ('U', 'áµ'),
        ('V', 'â±½'),
        ('W', 'áµ‚'),
        ('a', 'áµƒ'),
        ('b', 'áµ‡'),
        ('c', 'á¶œ'),
        ('d', 'áµˆ'),
        ('e', 'áµ‰'),
        ('f', 'á¶ '),
        ('g', 'áµ'),
        ('h', 'Ê°'),
        ('i', 'â±'),
        ('j', 'Ê²'),
        ('k', 'áµ'),
        ('l', 'Ë¡'),
        ('m', 'áµ'),
        ('n', 'â¿'),
        ('o', 'áµ’'),
        ('p', 'áµ–'),
        ('r', 'Ê³'),
        ('s', 'Ë¢'),
        ('t', 'áµ—'),
        ('u', 'áµ˜'),
        ('v', 'áµ›'),
        ('w', 'Ê·'),
        ('x', 'Ë£'),
        ('y', 'Ê¸'),
        ('z', 'á¶»'),
        // greek letters
        ('Î²', 'áµ'),
        ('Î³', 'áµž'),
        ('Î´', 'áµŸ'),
        ('Îµ', 'áµ‹'),
        ('Î¸', 'á¶¿'),
        ('Î¹', 'á¶¥'),
        ('Ï…', 'á¶¹'),
        ('Ï†', 'áµ '),
        ('Ï‡', 'áµ¡'),
        // Latin Extended-D
        ('ê¯', 'ê°'),
        ('C', 'êŸ²'),
        ('F', 'êŸ³'),
        ('Q', 'êŸ´'),
        // Latin Extended-E
        ('Ê', 'ê­©'),
        // Latin Extended-F
        ('Ë‘', 'ðž‚'),
        ('Ã¦', 'ðžƒ'),
        ('Ê™', 'ðž„'),
        ('É“', 'ðž…'),
        ('Ê£', 'ðž‡'),
        ('ê­¦', 'ðžˆ'),
        ('Ê¥', 'ðž‰'),
        ('Ê¤', 'ðžŠ'),
        ('É–', 'ðž‹'),
        ('É—', 'ðžŒ'),
        ('á¶‘', 'ðž'),
        ('É˜', 'ðžŽ'),
        ('Éž', 'ðž'),
        ('Ê©', 'ðž'),
        ('É¤', 'ðž‘'),
        ('É¢', 'ðž’'),
        ('É ', 'ðž“'),
        ('Ê›', 'ðž”'),
        ('Ä§', 'ðž•'),
        ('Êœ', 'ðž–'),
        ('É§', 'ðž—'),
        ('Ê„', 'ðž˜'),
        ('Êª', 'ðž™'),
        ('Ê«', 'ðžš'),
        ('É¬', 'ðž›'),
        ('ð¼„', 'ðžœ'),
        ('êžŽ', 'ðž'),
        ('É®', 'ðžž'),
        ('ð¼…', 'ðžŸ'),
        ('ÊŽ', 'ðž '),
        ('ð¼†', 'ðž¡'),
        ('Ã¸', 'ðž¢'),
        ('É¶', 'ðž£'),
        ('É·', 'ðž¤'),
        ('q', 'ðž¥'),
        ('Éº', 'ðž¦'),
        ('ð¼ˆ', 'ðž§'),
        ('É½', 'ðž¨'),
        ('É¾', 'ðž©'),
        ('Ê€', 'ðžª'),
        ('Ê¨', 'ðž«'),
        ('Ê¦', 'ðž¬'),
        ('ê­§', 'ðž­'),
        ('Ê§', 'ðž®'),
        ('Êˆ', 'ðž¯'),
        ('â±±', 'ðž°'),
        ('Ê', 'ðž²'),
        ('Ê¡', 'ðž³'),
        ('Ê¢', 'ðž´'),
        ('Ê˜', 'ðžµ'),
        ('Ç€', 'ðž¶'),
        ('Ç', 'ðž·'),
        ('Ç‚', 'ðž¸'),
        ('ð¼Š', 'ðž¹'),
        ('ð¼ž', 'ðžº'),
        // Spacing Modifier Letters
        ('h', 'Ê°'),
        ('É¦', 'Ê±'),
        ('j', 'Ê²'),
        ('r', 'Ê³'),
        ('É¹', 'Ê´'),
        ('É»', 'Êµ'),
        ('Ê€', 'Ê¶'),
        ('w', 'Ê·'),
        ('y', 'Ê¸'),
        ('Ê”', 'Ë€'),
        ('Ê•', 'Ë'),
        ('É£', 'Ë '),
        ('l', 'Ë¡'),
        ('s', 'Ë¢'),
        ('x', 'Ë£'),
        // Phonetic Extensions
        ('A', 'á´¬'),
        ('Ã†', 'á´­'),
        ('B', 'á´®'),
        ('á´ƒ', 'á´¯'),
        ('D', 'á´°'),
        ('E', 'á´±'),
        ('ÆŽ', 'á´²'),
        ('G', 'á´³'),
        ('H', 'á´´'),
        ('I', 'á´µ'),
        ('J', 'á´¶'),
        ('K', 'á´·'),
        ('L', 'á´¸'),
        ('M', 'á´¹'),
        ('N', 'á´º'),
        ('á´Ž', 'á´»'),
        ('O', 'á´¼'),
        ('È¢', 'á´½'),
        ('P', 'á´¾'),
        ('R', 'á´¿'),
        ('T', 'áµ€'),
        ('U', 'áµ'),
        ('W', 'áµ‚'),
        ('a', 'áµƒ'),
        ('É', 'áµ„'),
        ('É‘', 'áµ…'),
        ('á´‚', 'áµ†'),
        ('b', 'áµ‡'),
        ('d', 'áµˆ'),
        ('e', 'áµ‰'),
        ('É™', 'áµŠ'),
        ('É›', 'áµ‹'),
        ('á´ˆ', 'áµŒ'),
        ('g', 'áµ'),
        ('k', 'áµ'),
        ('m', 'áµ'),
        ('Å‹', 'áµ‘'),
        ('o', 'áµ’'),
        ('É”', 'áµ“'),
        ('p', 'áµ–'),
        ('t', 'áµ—'),
        ('u', 'áµ˜'),
        ('É¯', 'áµš'),
        ('v', 'áµ›'),
        ('êžµ', 'áµ'),
        ('Î³', 'áµž'),
        ('áºŸ', 'áµŸ'),
        ('Ï†', 'áµ '),
        ('ê­“', 'áµ¡'),
        ('Ð', 'áµ¸'),
        ('á´‰', 'áµŽ'),
        ('á´–', 'áµ”'),
        ('á´—', 'áµ•'),
        ('á´', 'áµ™'),
        ('ï»Œ', 'áµœ'),
        // Phonetic Extensions Supplement
        ('É’', 'á¶›'),
        ('c', 'á¶œ'),
        ('É•', 'á¶'),
        ('Ã°', 'á¶ž'),
        ('Éœ', 'á¶Ÿ'),
        ('f', 'á¶ '),
        ('ÉŸ', 'á¶¡'),
        ('É¡', 'á¶¢'),
        ('É¥', 'á¶£'),
        ('É¨', 'á¶¤'),
        ('É©', 'á¶¥'),
        ('Éª', 'á¶¦'),
        ('áµ»', 'á¶§'),
        ('Ê', 'á¶¨'),
        ('É­', 'á¶©'),
        ('á¶…', 'á¶ª'),
        ('ÊŸ', 'á¶«'),
        ('É±', 'á¶¬'),
        ('É°', 'á¶­'),
        ('É²', 'á¶®'),
        ('É³', 'á¶¯'),
        ('É´', 'á¶°'),
        ('Éµ', 'á¶±'),
        ('É¸', 'á¶²'),
        ('Ê‚', 'á¶³'),
        ('Êƒ', 'á¶´'),
        ('Æ«', 'á¶µ'),
        ('Ê‰', 'á¶¶'),
        ('ÊŠ', 'á¶·'),
        ('á´œ', 'á¶¸'),
        ('Ê‹', 'á¶¹'),
        ('ÊŒ', 'á¶º'),
        ('z', 'á¶»'),
        ('Ê', 'á¶¼'),
        ('Ê‘', 'á¶½'),
        ('Ê’', 'á¶¾'),
        ('Î¸', 'á¶¿'),
        // Cyrillic Extended-B
        ('ÑŠ', 'êšœ'),
        ('ÑŒ', 'êš'),
        // Cyrillic Extended-D
        ('Ð°', 'ðž€°'),
        ('Ð±', 'ðž€±'),
        ('Ð²', 'ðž€²'),
        ('Ð³', 'ðž€³'),
        ('Ð·', 'ðž€·'),
        ('Ðµ', 'ðž€µ'),
        ('Ð¶', 'ðž€¶'),
        ('Ð·', 'ðž€·'),
        ('Ð¸', 'ðž€¸'),
        ('Ðº', 'ðž€¹'),
        ('Ð»', 'ðž€º'),
        ('Ð¼', 'ðž€»'),
        ('Ð¾', 'ðž€¼'),
        ('Ð¿', 'ðž€½'),
        ('Ñ€', 'ðž€¾'),
        ('Ñ', 'ðž€¿'),
        ('Ñ‚', 'ðž€'),
        ('Ñƒ', 'ðž'),
        ('Ñ„', 'ðž‚'),
        ('Ñ…', 'ðžƒ'),
        ('Ñ†', 'ðž„'),
        ('Ñ‡', 'ðž…'),
        ('Ñˆ', 'ðž†'),
        ('Ñ‹', 'ðž‡'),
        ('Ñ', 'ðžˆ'),
        ('ÑŽ', 'ðž‰'),
        ('êš‰', 'ðžŠ'),
        ('Ó™', 'ðž‹'),
        ('Ñ–', 'ðžŒ'),
        ('Ñ˜', 'ðž'),
        ('Ó©', 'ðžŽ'),
        ('Ò¯', 'ðž'),
        ('Ó', 'ðž'),
        ('Ò«', 'ðž«'),
        ('ê™‘', 'ðž¬'),
        ('Ò±', 'ðž­'),
        // Georgian
        ('áƒœ', 'áƒ¼'),
    ];

    fn lookup_char(arg: char) -> Option<char> {
        for (regular, subscr) in Self::SUPERSCRIPT_MAP.iter() {
            if arg == *regular {
                return Some(*subscr);
            }
        }
        None
    }
    
    fn apply_replacements(text: &str) -> String {
        let mut subscript_string = String::new();
    
        for chr in text.chars() {
            if chr.is_whitespace() {
                subscript_string.push(chr);
                continue;
            }
    
            subscript_string.push(match Self::lookup_char(chr) {
                Some(subscript_char) => subscript_char,
                None => chr,
            });
        }
    
        subscript_string
    }
}

impl traits::Op for Superscript {
    fn name() -> &'static str { "superscript" }
    fn usage() -> &'static str { "<#1 string to-convert>" }
    fn description() -> &'static str { "return the superscript version of the provided string #1" }
    fn acceptable_number_of_arguments() -> range::Range { range::Range::IndexIndex(1, 1) }

    fn priority(args: &Args, _conf: &Configuration) -> Result<f32, LibError> {
        let text: &str = args.get(0)?.try_into()?;
        let sub: &str = &Self::apply_replacements(text);
        let diff = auxiliary::count_different_codepoints_of_shorter_string(text, sub);

        Ok(match diff {
            0 => 0.0,
            1 => 0.69,
            _ => 1. / diff as f32,
        })
    }

    fn run(args: &Args, _conf: &Configuration) -> Result<Output, LibError> {
        let text: &str = args.get(0)?.try_into()?;
        Ok(Self::apply_replacements(text).into())
    }
}
